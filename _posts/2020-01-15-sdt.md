---
layout: post
title:  "My Notes on SuBDomain Takeovers- A Blue Team Prospective"
date:   2020-01-15
excerpt: "SubDomain Takeovers"
tag:
- Threat Hunting 
- Blue Team
- Beginner
- SubDomain Takeovers Monitoring
- Automation 
comments: true
---

Subdomain takeovers are quite common these days and as **Frans Rosén** rightly said in his  <a href="https://www.youtube.com/watch?v=HhJv8CU-RIk">talk</a> that SubDomain takeovers are modern day XSS. Companies spends thousands of dollars to buy shiny new tools and suddenly a bug report from bounty hunters made us realize that how a small misconfiguration can cause harm to a company's reputation or assests. While you will get a lot of articles on how to verify if a website subdomain takeover is vulnerable to subdomain takeovers there were very less articles from a blueteam/soc/threat-hunting prospectives. This post is an effort to add something in the later(BlueTeam) section. Most of the content that I will be discussing here is a fusion of great series of posts done by <a href="https://0xpatrik.com/subdomain-takeover-basics/">Patrick Hudak</a>, <a href="https://www.hackerone.com/blog/Guide-Subdomain-Takeovers">HackerOne</a> and <a href="https://labs.detectify.com/2014/10/21/hostile-subdomain-takeover-using-herokugithubdesk-more/">Detectify</a>. I have just tried to organize my understanding of subdomain takeover topic in this blog post. Hopefully it will help someone connecting the dots while they are in the process of understanding subdomain takeover topic.


## What is SubDomain TakeOver
Before proceeding further,lets try to understand what exactly is a domain takeover. If we have to summarize it in short words, it is basically DNS Spoofing. Your browser is blindly trusting the IP address given by DNS resolver to him. The detailed and simpler definition is provided by Patrik Hudak in his article SubDomain TakeOver Basics as:

*`"Subdomain takeover is a process of registering a non-existing domain name to gain control over another domain."`*

<figure>
	<a href="https://ibb.co/tb28hYW"><img src="https://i.ibb.co/FBYgW8j/a.png" alt="a" border="0"></a>
	<figcaption><a href="http://www.flickr.com/photos/80901381@N04/7758832526/" title="Morning Fog Emerging From Trees by A Guy Taking Pictures, on Flickr">dig results of a domain mybucket.bla.net </a>.</figcaption>
</figure>

Consider the above example where the main domain is pointed to CNAME starting with `serice` which further points to `s3-test.amazonaws.com`. Now If aftersome ,I remove all the content from above S3 bucket (`s3-test.amazonaws.com`) then ,it will be released from my AWS account and anybody can register it and when that happens(someone register the s3 bucket with the same name) ,subdomain takeover happens.

Common theoretical example would be you are hosting an event for Saving The Stray Dogs and you register one domain for the same i.e. savethestraydog.com with the domain registrar. Now you hosted a simple static page on S3. After the event is over ,you removed the GitHub page but forgot to  remove the CNAME entry which points to the S3 Static Website. Now an attacker can claim this S3 bucket and can upload anything he/she wants. This is what essentially known as SubDomain Takeover


## Ok,Got It.What Why Do I Care about it ?

SubDomain Takeover is one of the attack methods which are completely traceless. A successful subdomain takeover can open gates to various attack vectors such as phishing email,XSS,reputation loss and even reading the internal email of the users. Just search google for “SubDomain Takeover HackerOne” and look for the bounties provided by companies to the BugBounty hunter for reporting such bugs. You can read more detailed risk as mentioned by Patrik Hudak in his blog. It is completely useless to copy paste the content if it is already available. In short,it can lead to much bigger attacks,can cost money to company and results in loss of reputation of company.

## How Does TakeOvers Happens? 

There are various articles over the internet which explain it in details. Two of my favorites are as below:

1.  <a href="https://www.hackerone.com/blog/Guide-Subdomain-Takeovers">Guide to SubDomain Takeovers</a> 
  
2.  <a href="https://0xpatrik.com/takeover-proofs/">TakeOver Proofs</a> 

I will provide a summarised version of both to grasp/simply the concept for you. The first step is to decide the target domain such as example.com. You decided that you will try to find any potential subdomain takeover for this example.com. Now the next step is to find all the subdomains in the domain example.com. There are various methods to get this list of subdomain. Most experienced BugHunters usually use a combination of tools,API to get this list. Once you have a list of SubDomains ,you next task is to find the potential vulnerable domains which may result  in subdomain takeovers. Now the questions comes ,how do you find such potential vulnerable domains? The answer is you need to look for various strings in the error messages to identify if a particular subdomain can results in takeover.  There is a already a <a href="https://github.com/EdOverflow/can-i-take-over-xyz">GitHub Project</a> which tracks and provide methods to identify strings. For example,if you get error string such as  **`The specified bucket does not exist`** that means it is vulnerable to subdomain takeover. Once you have identified it is vulnerable to Subdomain takeover then you can follow the step by step guide provided by in Patrix's article <a href="https://0xpatrik.com/takeover-proofs/">Takeover Proofs</a>. 


## How it Can be prevented?
The main idea for the organizations to prevent subdomain takeover is to keep on checking the Dead DNS records in their DNS infrastructure. There process of removing the DNS record should be mandatory while decommissioning any of the internet facing application. This has to be more strict if you are using any third party cloud provider such as `AWS`,`Azure`,`Heroku` etc.

The second method to prevent this is to hack yourself before someone else does which essentially means takeover the potential vulnerable domain before it is taken over by external attacker or bug bounty hunter. Such an approach required efforts by Security Team to setup the system which continuously fetching all the subdomain from various data source available over the internet as well as dumping the DNS zone files and then running tools to see if any of these subdomain are vulnerable.


Now,I hope you may got the basic idea and brevity about subdomain takeovers. Lets jump into the Blue Team part of it.
{: .notice}

## Designing a Monitoring System for SubDomain TakeOver
    
<figure>
	<blockquote class="imgur-embed-pub" lang="en" data-id="a/4txRHZQ"><a href="//imgur.com/a/4txRHZQ"></a></blockquote><script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script>	
    <figcaption><a href="http://www.flickr.com/photos/80901381@N04/7758832526/" title="Morning Fog Emerging From Trees by A Guy Taking Pictures, on Flickr"><center>Mind-Map-Tools-Techniques.</center></a>.</figcaption>
</figure>

