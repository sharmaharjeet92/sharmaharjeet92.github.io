---
layout: post
title:  "Introduction to Server Hardening and creating Golden AMIs-2"
date:   2020-03-04
excerpt: "Server Hardening Part 2"
tag:
- Server Hardening 
- Auditing
- Compliance Checks
- CI/CD Pipeline
- Automation 
- DevSecOps
- AWS
- GoldenAMI
comments: true
---
In the last <a href="https://www.harjeetsharma.com/sh/ ">article</a>, we have discussed most of the theory part of server hardening to have a solid understanding of basic concepts. In this article, I will show how you can automate the process of fixing the gaps using OpenSCAP, Ansible and PowerShell's DSC. We will be discussing Powershell DSC majorly but I will try to touch base the other two as well. 

## Remediation using PowerShell DSC
Before we proceed with it, it is important to understand what exactly  PowerShell DSC is. In simple English terms, Microsoft's PowerShell Desired State Configuration is a captain that instructs Operating System to be in a specific state, no matter what happens. It gives the order and operating system figure out how it can achieve this. In technical terms, it is Microsoft's solution for infrastructure as code similar to HashiCorp's Terraform. Although it is not the same as Terraform, this analogy will help you to understand it better. Microsoft has done a pretty decent job in explaining the basics of PowerShell DSC so I will not be reinventing the wheel. You can learn in detail about Powershell DSC in below links:

1.  <a href="https://docs.microsoft.com/en-us/powershell/scripting/dsc/overview/overview?view=powershell-7">DSC  Basics </a>
2.  <a href="https://nedimmehic.org/2019/04/16/desired-state-configuration-dsc-get-started/">Getting Started with DSC</a>
3.  <a href="https://www.youtube.com/watch?v=o_a_IHDPo20">DSC Tech Talk </a>

There are 3 key concepts that you need to grasp to fully understand PowerShell DSC,these are:

1.  **Configurations**: Congratulations in DSC realm are the set of scripts/instructions using which system attain the desired state. When these configurations(scripts) are run, the system will attain the desired state.

2.  **Resources**: Desired State Configuration (DSC) Resources provide the building blocks for a DSC configuration. A resource exposes properties that can be configured (schema) and contains the PowerShell script functions that the Local Configuration Manager (LCM) calls to "make it so". For example HostsFile is a resource in DSC which has the property to add, edit and remove entries. Using Powershell scripting language we can apply logic and functions on the resources.

3.  **LCM**: Local Configuration Manager is another important component of DSC. Think of it as the engine which applies all the settings as asked by configuration. It is like a supervisor who keeps on polling the system's settings to see if the system is in the state as mentioned in the configuration. Just like a kid who is supervising a class in the absence of a teacher(SysAdmin), LCM can notify the sysadmin, if a system "Drifts" from the normal state. Sometimes depending upon the configuration, it can revert the configuration to the original desired state.

4. **Push/Pull Model**: DSC works in two modes. The names pretty much explain the mode of operation. In Pull model LCM polls a central DSC for the latest configuration and in push model a single machine pushes the configuration to multiple machines.

Hopefully, you have got the idea about what exactly PowerShell DSC is, let's move to our main task i.e. *fixing the gaps as per CIS benchmarks.* I have used <a href="https://github.com/johndejager">John de Jager's </a>script as the baseline and added minor tweaks. It can be accessed <a href= "https://github.com/johndejager/DSC_CISConfigurations">here </a>

This guide is a step by step guide to harden a Microsoft windows server using PowerShell DSC (Desired State Configuration). All the hardening guidelines are taken from the CIS Benchmarks guidelines for Microsoft Server 2016 level 1. 

>Although extreme care has been taken to make it as generic as possible, however, there might be instances when a few controls are tighter and may break your application functionality. We strongly recommend testing this configuration in the Development environment first before taking it to production.

Open Command Prompt as Admin as shown below:
<figure>
   <a data-flickr-embed="true" href="https://www.flickr.com/photos/185801550@N06/49616176873/in/dateposted-public/" title="1"><img src="https://live.staticflickr.com/65535/49616176873_613a4658a7_b.jpg" width="1024" height="450" alt="Screenshot 2020-02-27 at 2.22.11 PM"></a>
   <figcaption><a href="https://live.staticflickr.com/65535/49616176873_613a4658a7_b.jpg" title="DSC"><center>DSC</center></a>.</figcaption>
</figure>
Type powershell in the command prompt:
<figure>
<a data-flickr-embed="true" href="https://www.flickr.com/photos/185801550@N06/49616694106/in/dateposted-public/" title="Screenshot 2020-02-27 at 2.22.30 PM"><img src="https://live.staticflickr.com/65535/49616694106_63123b96b7_b.jpg" width="1024" height="471" alt="Screenshot 2020-02-27 at 2.22.30 PM"></a>
</figure>
Run Below Commands
{% highlight css %}
Install-Module NetworkingDsc -Verbose 
Install-Module AuditPolicyDsc -Verbose 
Install-Module SecurityPolicyDsc -Verbose 
Install-Module PSDscResources -Verbose
{% endhighlight %}
*Respond with A for all*

<figure>
<a data-flickr-embed="true" href="https://www.flickr.com/photos/185801550@N06/49616694451/in/dateposted-public/" title="Screenshot 2020-02-27 at 2.24.27 PM"><img src="https://live.staticflickr.com/65535/49616694451_59ec867e99_b.jpg" width="1024" height="531" alt="Screenshot 2020-02-27 at 2.24.27 PM"></a>
</figure>

**Error due to Network Interface Name**
>Since AWS doesn’t have persistent methods to always give the same name to the network interfaces. Sometimes what happens is that the network interface alias assigned by AWS inside Windows Server is “Ethernet 2“ or sometimes it will be “Ethernet”. You need to modify the piece of the script according to this name. How to check what interface name has been assigned to you? Run below command in powershell **Get-NetIPInterface** and Change the piece of code as below(Line 15):

<figure>
<a data-flickr-embed="true" href="https://www.flickr.com/photos/185801550@N06/49616952727/in/dateposted-public/" title="Screenshot 2020-02-28 at 9.20.04 AM"><img src="https://live.staticflickr.com/65535/49616952727_a4bfde3369_b.jpg" width="1024" height="337" alt="Screenshot 2020-02-28 at 9.20.04 AM"></a>
</figure>

<figure>
<a data-flickr-embed="true" href="https://www.flickr.com/photos/185801550@N06/49616697966/in/dateposted-public/" title="Screenshot 2020-02-28 at 9.20.21 AM"><img src="https://live.staticflickr.com/65535/49616697966_68c910a599_b.jpg" width="1024" height="154" alt="Screenshot 2020-02-28 at 9.20.21 AM"></a>
</figure>


